<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enigma | Конвертер изображений</title>
    <link rel="icon" type="image/png" href="img/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="img/favicon/favicon.svg" />
    <link rel="shortcut icon" href="img/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="MyWebSite" />
    <link rel="manifest" href="img/favicon/site.webmanifest" />
    <script src="vendors/tailwindcss/script.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="vendors/font-awesome/css/all.min.css">
    <style>
        .drop-zone {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px dashed #94a3b8;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(8px);
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: #2563eb;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #2563eb;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .preview-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .preview-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .gradient-text {
            background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .history-item {
            transition: all 0.3s ease;
        }

        .history-item:hover {
            transform: translateX(5px);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-12">
        <div class="max-w-4xl mx-auto">
            <div class="glass-effect rounded-3xl shadow-2xl overflow-hidden">
                <!-- Хедер -->
                <div
                    class="bg-gradient-to-r from-blue-600 via-indigo-600 to-violet-600 px-8 py-8 flex justify-between items-center">
                    <h1 class="text-4xl font-bold text-white flex items-center">
                        <i class="fas fa-image mr-4"></i> Конвертер изображений
                    </h1>

                    <!-- Тулбар -->
                    <div class="space-x-4">
                        <button @click="openLogs"
                            class="px-4 py-2 bg-blue-700 hover:bg-blue-800 rounded text-white transition"
                            title="Показать логи">
                            <i class="fas fa-file-alt mr-2"></i> Логи
                        </button>
                        <a href="test/index.html" target="_blank"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-white transition"
                            title="Перейти к тестам">
                            <i class="fas fa-vials mr-2"></i> Тесты
                        </a>
                    </div>
                </div>

                <!-- Контент -->
                <div class="p-8">
                    <!-- Dropzone -->
                    <div class="drop-zone rounded-2xl p-12 text-center" :class="{ dragover: isDragOver }"
                        @click="triggerFileInput" @dragenter.prevent="isDragOver = true" @dragover.prevent
                        @dragleave.prevent="isDragOver = false" @drop.prevent="handleDrop">
                        <input type="file" ref="fileInput" multiple accept="image/*" class="hidden"
                            @change="handleFiles" />
                        <div class="space-y-6 select-none">
                            <i class="fas fa-cloud-upload-alt text-7xl text-blue-500"></i>
                            <h4 class="text-2xl font-semibold text-gray-800">Перетащите изображения сюда</h4>
                            <p class="text-base text-gray-600">или нажмите для выбора файлов</p>
                            <p class="text-sm text-gray-500">Поддерживаются форматы: JPG, PNG, GIF</p>
                        </div>
                    </div>

                    <!-- Формат и качество -->
                    <div class="mt-12 space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="glass-effect p-8 rounded-2xl">
                                <label for="format" class="block text-lg font-medium text-gray-800 mb-4">
                                    <i class="fas fa-file-image mr-3 text-blue-500"></i> Формат выходного файла
                                </label>
                                <select id="format" v-model="format"
                                    class="w-full rounded-xl border-gray-200 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-white text-lg">
                                    <option value="webp">WebP</option>
                                    <option value="avif">AVIF</option>
                                    <option value="jpeg">JPEG</option>
                                    <option value="png">PNG</option>
                                </select>
                            </div>

                            <div class="glass-effect p-8 rounded-2xl">
                                <label for="quality" class="block text-lg font-medium text-gray-800 mb-4">
                                    <i class="fas fa-sliders-h mr-3 text-blue-500"></i> Качество (0-100%)
                                </label>
                                <input type="range" id="quality" min="0" max="100" step="5" v-model.number="quality"
                                    class="w-full" />
                                <div class="text-center text-lg font-medium text-gray-800 quality-value mt-4">
                                    {{ quality }}%
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Превью -->
                    <div id="preview" class="mt-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="file in previewFiles" :key="file.id" class="preview-item p-4">
                            <div class="relative">
                                <img :src="file.dataUrl" class="w-full h-48 object-cover rounded-lg" :alt="file.name" />
                                <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-300 rounded-lg flex items-center justify-center"
                                    :class="{ 'bg-opacity-20': file.status !== 'converting' }">
                                    <div class="status-indicator text-white px-4 py-2 rounded-lg" :class="{
                      'bg-green-500': file.status === 'done',
                      'bg-red-50 text-red-600': file.status === 'error'
                    }">
                                        <template v-if="file.status === 'converting'">
                                            <i class="fas fa-spinner fa-spin mr-2"></i> Конвертация...
                                        </template>
                                        <template v-else-if="file.status === 'done'">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-check-circle text-green-100"></i>
                                                <span>Конвертировано</span>
                                                <a :href="file.downloadPath" target="_blank"
                                                    class="text-blue-100 hover:text-blue-300">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                            </div>
                                        </template>
                                        <template v-else-if="file.status === 'error'">
                                            <div class="flex items-center space-x-2">
                                                <i class="fas fa-exclamation-circle text-red-500"></i>
                                                <span>Ошибка конвертации</span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <p class="text-sm font-medium text-gray-800 truncate">{{ file.name }}</p>
                                <p class="text-xs text-gray-500">{{ (file.size / 1024).toFixed(1) }} KB</p>
                            </div>
                        </div>
                    </div>

                    <!-- Прогресс -->
                    <div id="progressBar" class="mt-8" v-show="isProgressVisible">
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="bg-gradient-to-r from-blue-500 to-indigo-500 h-3 rounded-full transition-all duration-300"
                                :style="{ width: progressWidth + '%' }"></div>
                        </div>
                    </div>

                    <!-- История -->
                    <div class="mt-16">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-history mr-3 text-blue-500"></i> История конвертаций
                        </h2>
                        <div id="history" class="space-y-4">
                            <div v-if="conversionHistory.length === 0" class="text-center text-gray-500 py-8">
                                <i class="fas fa-history text-4xl mb-4"></i>
                                <p>История конвертаций пуста</p>
                            </div>

                            <div v-for="(item, idx) in conversionHistory" :key="item.timestamp + idx"
                                class="history-item glass-effect p-4 rounded-xl flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                                        <img :src="item.downloadPath" width="100%" height="100%" alt="convert" />
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-gray-800">{{ item.fileName }}</h3>
                                        <p class="text-sm text-gray-500">
                                            Конвертировано в {{ item.format.toUpperCase() }} (качество: {{ item.quality
                                            }}%)
                                        </p>
                                        <p class="text-xs text-gray-400">
                                            {{ formatDate(item.timestamp) }}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <a :href="item.downloadPath" target="_blank"
                                        class="text-blue-500 hover:text-blue-600 p-2 rounded-lg hover:bg-blue-50">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    <button @click="deleteHistoryItem(idx)"
                                        class="text-red-500 hover:text-red-600 p-2 rounded-lg hover:bg-red-50">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Модалка Логов -->
            <div v-if="showLogsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                @click.self="closeLogs">
                <div class="bg-white rounded-xl shadow-lg max-w-4xl w-full max-h-[80vh] overflow-auto p-6 relative">
                    <!-- Кнопка закрыть -->
                    <button class="absolute top-3 right-3 text-black text-2xl font-bold hover:text-red-500 transition"
                        @click="closeLogs" aria-label="Закрыть">
                        ×
                    </button>

                    <h2 class="text-2xl font-bold mb-4">Логи ({{ logsCount }})</h2>

                    <div class="flex mb-4 space-x-3">
                        <select v-model="logLevelFilter" class="border border-gray-400 rounded px-2 py-1 text-base">
                            <option value="all">Все уровни</option>
                            <option value="ERROR">Ошибка</option>
                            <option value="WARNING">Предупреждение</option>
                            <option value="INFO">Инфо</option>
                            <option value="SUCCESS">Успех</option>
                            <option value="START">Старт</option>
                            <option value="THE-END">Завершение</option>
                        </select>
                        <input v-model="logSearch" placeholder="Поиск по логам"
                            class="border border-gray-400 rounded px-2 py-1 flex-grow" autocomplete="off" type="text" />
                    </div>

                    <div v-if="logsLoading" class="text-center py-12 text-gray-600 font-semibold">
                        Загрузка...
                    </div>

                    <div v-else-if="filteredLogs.length === 0" class="text-center py-12 text-gray-500">
                        Логи не найдены
                    </div>

                    <ul class="divide-y divide-gray-200 max-h-[55vh] overflow-y-auto font-mono text-sm">
                        <li v-for="(log, idx) in filteredLogs" :key="idx" class="py-2 px-3 hover:bg-gray-100">
                            <div><b>Время:</b> {{ log.time }}</div>
                            <div><b>Тип:</b> <span :class="logTypeClass(log.type)">{{ log.type }}</span></div>
                            <div><b>IP:</b> {{ log.ip }}</div>
                            <div><b>Сообщение:</b> {{ log.message }}</div>
                            <pre
                                class="bg-gray-100 p-2 rounded mt-1 text-xs overflow-x-auto">{{ JSON.stringify(log.data, null, 2) }}</pre>
                        </li>
                    </ul>
                </div>
            </div>

        </div>
    </div>
    <script>
        const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                // Drag & Drop
                const isDragOver = ref(false);
                const format = ref('webp');
                const quality = ref(70);
                const progressWidth = ref(0);
                const isProgressVisible = ref(false);

                const previewFiles = reactive([]);

                // Логи
                const showLogsModal = ref(false);
                const logs = ref([]);
                const filteredLogs = ref([]);
                const logLevelFilter = ref('all');
                const logSearch = ref('');
                const logsCount = ref(0);
                const logsLoading = ref(false);

                // История конвертаций (из localStorage)
                const conversionHistory = ref([]);

                // Загрузка истории из localStorage
                function loadHistory() {
                    const raw = localStorage.getItem('conversionHistory');
                    if (raw) {
                        try {
                            conversionHistory.value = JSON.parse(raw);
                        } catch {
                            conversionHistory.value = [];
                        }
                    }
                }

                // Сохранение истории в localStorage
                function saveHistory() {
                    localStorage.setItem('conversionHistory', JSON.stringify(conversionHistory.value));
                }

                // Удаление элемента истории
                function deleteHistoryItem(idx) {
                    conversionHistory.value.splice(idx, 1);
                    saveHistory();
                }

                // Формат даты
                function formatDate(timestamp) {
                    const d = new Date(timestamp);
                    return d.toLocaleString();
                }

                // Открыть/закрыть модалку логов
                function openLogs() {
                    showLogsModal.value = true;
                    loadLogs();
                }
                function closeLogs() {
                    showLogsModal.value = false;
                }

                // Триггер выбора файла
                const fileInput = ref(null);
                function triggerFileInput() {
                    fileInput.value?.click();
                }

                // Обработка файлов
                function handleFiles(e) {
                    const files = e.target.files || e.dataTransfer?.files;
                    if (!files) return;

                    addFiles(files);
                    if (e.target) e.target.value = ''; // очистить input
                }

                // Обработка drop
                function handleDrop(e) {
                    isDragOver.value = false;
                    const files = e.dataTransfer.files;
                    addFiles(files);
                }

                // Добавление файлов в previewFiles + старт конвертации
                function addFiles(fileList) {
                    for (const file of fileList) {
                        if (!file.type.startsWith('image/')) continue;

                        // создаём объект файла с начальными данными
                        const fileObj = {
                            id: Date.now() + Math.random(),
                            file,
                            name: file.name,
                            size: file.size,
                            dataUrl: '',
                            status: 'loading', // загрузка dataUrl
                            downloadPath: '#',
                        };
                        previewFiles.push(fileObj);

                        // Считываем для превью
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            fileObj.dataUrl = e.target.result;
                            fileObj.status = 'converting'; // готов к конвертации
                            convertFile(fileObj);
                        };
                        reader.readAsDataURL(file);
                    }
                }

                // Конвертация файла: реальный вызов API
                async function convertFile(fileObj) {
                    isProgressVisible.value = true;
                    progressWidth.value = 0;

                    try {
                        // Формируем форму с данными
                        const formData = new FormData();
                        formData.append('image', fileObj.file);
                        formData.append('format', format.value);
                        formData.append('quality', quality.value);

                        // Отправляем запрос на конвертацию (замени URL на свой API)
                        const response = await fetch('http://localhost/convertor_www/api/v1/convert.php', {
                            method: 'POST',
                            body: formData,
                        });

                        if (!response.ok) throw new Error('Ошибка сервера при конвертации');

                        // Считаем прогресс загрузки результата (если есть)
                        // Тут простой пример без прогресса загрузки

                        const result = await response.json();

                        if (result.success && result.url) {
                            fileObj.status = 'done';
                            fileObj.downloadPath = result.url;

                            // Добавляем в историю
                            conversionHistory.value.unshift({
                                fileName: fileObj.name,
                                format: format.value,
                                quality: quality.value,
                                timestamp: Date.now(),
                                downloadPath: result.url,
                            });
                            saveHistory();
                        } else {
                            fileObj.status = 'error';
                        }
                    } catch (err) {
                        fileObj.status = 'error';
                    } finally {
                        progressWidth.value = 100;
                        setTimeout(() => {
                            isProgressVisible.value = false;
                            progressWidth.value = 0;
                        }, 500);
                    }
                }

                // Загрузка и парсинг логов
                async function loadLogs() {
                    logsLoading.value = true;
                    try {
                        const res = await fetch('logs/converter.log', { cache: 'no-store' });
                        if (!res.ok) throw new Error('Ошибка загрузки логов');
                        const text = await res.text();
                        logs.value = parseLogs(text);
                        filterLogs();
                    } catch (e) {
                        logs.value = [];
                    } finally {
                        logsLoading.value = false;
                    }
                }

                // Парсинг логов
                function parseLogs(logText) {
                    const logEntries = [];
                    const ops = logText.split('=======================\n\n').filter(Boolean);
                    for (const op of ops) {
                        const lines = op.split('\n').filter(Boolean);
                        if (lines.length < 5) continue;
                        logEntries.push({
                            time: lines[1].replace('Время начала: ', '').trim(),
                            ip: lines[2].replace('IP адрес: ', '').trim(),
                            type: lines[3].replace('Тип операции: ', '').trim(),
                            message: lines[4].replace('Сообщение: ', '').trim(),
                            data: {}
                        });
                    }
                    return logEntries.reverse();
                }

                // Фильтрация логов
                function filterLogs() {
                    const lvl = logLevelFilter.value;
                    const search = logSearch.value.toLowerCase();
                    filteredLogs.value = logs.value.filter(log => {
                        const levelMatch = lvl === 'all' || log.type === lvl;
                        const searchMatch =
                            log.message.toLowerCase().includes(search) ||
                            log.ip.toLowerCase().includes(search);
                        return levelMatch && searchMatch;
                    });
                    logsCount.value = filteredLogs.value.length;
                }

                // Отслеживаем фильтр и поиск
                watch([logLevelFilter, logSearch], filterLogs);

                onMounted(() => {
                    loadHistory();
                });

                return {
                    isDragOver,
                    format,
                    quality,
                    progressWidth,
                    isProgressVisible,
                    previewFiles,
                    fileInput,
                    triggerFileInput,
                    handleFiles,
                    handleDrop,
                    showLogsModal,
                    openLogs,
                    closeLogs,
                    logsLoading,
                    logsCount,
                    logLevelFilter,
                    logSearch,
                    filteredLogs,
                    conversionHistory,
                    deleteHistoryItem,
                    formatDate
                };
            }
        }).mount('#app');
    </script>
</body>

</html>